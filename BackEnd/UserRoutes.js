import express from 'express';
import crypto from 'crypto';
import nodemailer from 'nodemailer';
import bcrypt from 'bcrypt'
import db from './db.js'
import dotenv from 'dotenv';
import { generateVerificationEmail, generatePasswordResetEmail } from './utils/serverEmailTemplates.js'
import { generateVerificationMail, generatePasswordResetMail } from './utils/serverMailTemplates.js'
dotenv.config();

const router = express.Router();

// âœ… **Ð’Ñ…Ð¾Ð´ Ð² Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚*
router.post('/login', async (req, res) => {
  const { email, password } = req.body;

  try {
    const queryPromise = new Promise((resolve, reject) => {
      db.query(
        'SELECT * FROM users WHERE email = ?',
        [email],
        (err, results) => {
          if (err) {
            reject({ status: 500, error: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°.' });
          }
          if (results.length === 0) {
            reject({ status: 401, error: 'ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ email Ð¸Ð»Ð¸ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ.' });
          }
          const user = results[0];
      
          if (!user.is_verified) { 
            return reject({ status: 403, error: 'ÐÐºÐºÐ°ÑƒÐ½Ñ‚ Ð½Ðµ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð²Ð°ÑˆÑƒ Ð¿Ð¾Ñ‡Ñ‚Ñƒ.' });
          }

          resolve(user); 
        }
      );
    });

    const user = await queryPromise;

    const isPasswordValid = await bcrypt.compare(password, user.Password);
    console.log(isPasswordValid);

    if (!isPasswordValid) {
      return res.status(401).json({ error: 'ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ email Ð¸Ð»Ð¸ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ.' });
    }

    res.status(200).json({ message: 'Ð’Ñ…Ð¾Ð´ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!', user });

  } catch (error) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ñ…Ð¾Ð´Ð°:', error);
    res.status(error.status || 500).json({ error: error.error || 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°.' });
  }
});

// âœ… **Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ**
router.post('/register', async (req, res) => {
  const {name, email, password } = req.body;
  db.query('SELECT * FROM users WHERE email = ?', [email], async (err, results) => {
    if (err) {
      return res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°' });
    }

    if (results.length > 0) {
      return res.status(400).json({ error: 'ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ñ Ñ‚Ð°ÐºÐ¸Ð¼ email ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚' });
    }

    const hashedPassword = await bcrypt.hash(password, 10);
    
    db.query(
      'INSERT INTO users (name, email, password, is_verified, isAdmin) VALUES (?, ?, ?, ?, ?)',
      [name, email, hashedPassword, 0, 0],
      (err, result) => {
        if (err) {
          console.debug(err)
          return res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð° Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ' });
        }

        const userId = result.insertId;
        const token = crypto.randomBytes(32).toString('hex');
        db.query(
          'INSERT INTO email_verification_tokens (user_id, token, expires_at) VALUES (?, ?, ?)',
          [userId, token, new Date(Date.now() + 3600000)], // Ð¢Ð¾ÐºÐµÐ½ Ð¸ÑÑ‚ÐµÐºÐ°ÐµÑ‚ Ñ‡ÐµÑ€ÐµÐ· 1 Ñ‡Ð°Ñ
          (err) => {
            if (err) {
              console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ð¸ Ñ‚Ð¾ÐºÐµÐ½Ð°:', err);
            }

            if (email.endsWith("@gmail.com")) {
              console.log(`ðŸ“© ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ñ‡ÐµÑ€ÐµÐ· Gmail Ð½Ð° ${email}`);
              sendVerificationGmail(email, token, name);
            } else if (email.endsWith("@mail.ru")) {
              console.log(`ðŸ“© ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ñ‡ÐµÑ€ÐµÐ· Mail.ru Ð½Ð° ${email}`);
              sendVerificationEmail(email, token, name);
            } else if (email.endsWith("@yandex.ru")) {
              console.log(`ðŸ“© ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ñ‡ÐµÑ€ÐµÐ· Yandex.ru Ð½Ð° ${email}`);
              sendVerificationYandexEmail(email, token, name);
            } else {
              res.status(201).json({ message: 'Ð”Ð°Ð½Ð½Ñ‹Ð¹ Ð¿Ð¾Ñ‡Ñ‚Ð¾Ð²Ñ‹Ð¹ ÑÐµÑ€Ð²Ð¸Ñ Ð½Ð° Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ÑÑ.' });
              return;
            }
            res.status(201).json({ message: 'ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð·Ð°Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð¿Ð¾Ñ‡Ñ‚Ñƒ Ð´Ð»Ñ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ.' });
          }
        );
      }
    );
  });
});

// New endpoints for account settings
// âœ… **Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ð¿Ð°Ñ€Ð¾Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ*
router.post('/change-password', async (req, res) => {
  const { userId, currentPassword, newPassword } = req.body;

  try {
    // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¸Ð· Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
    const [user] = await new Promise((resolve, reject) => {
      db.query('SELECT password FROM users WHERE id = ?', [userId], (err, results) => {
        if (err) reject(err);
        resolve(results);
      });
    });

    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ
    const isPasswordValid = await bcrypt.compare(currentPassword, user.password);
    if (!isPasswordValid) {
      return res.status(401).json({ error: 'ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ' });
    }

    // Ð¥ÐµÑˆÐ¸Ñ€ÑƒÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ
    const hashedNewPassword = await bcrypt.hash(newPassword, 10);

    // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð² Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…
    await new Promise((resolve, reject) => {
      db.query('UPDATE users SET password = ? WHERE id = ?', [hashedNewPassword, userId], (err) => {
        if (err) reject(err);
        resolve();
      });
    });

    res.json({ message: 'ÐŸÐ°Ñ€Ð¾Ð»ÑŒ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½' });
  } catch (error) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¸ Ð¿Ð°Ñ€Ð¾Ð»Ñ:', error);
    res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°' });
  }
});

// Ð­Ð½Ð´Ð¿Ð¾Ð¸Ð½Ñ‚ Ð´Ð»Ñ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° ÑÐ±Ñ€Ð¾ÑÐ° Ð¿Ð°Ñ€Ð¾Ð»Ñ
router.post('/request-password-reset', async (req, res) => {
  const { email } = req.body;

  try {
    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
    const [user] = await new Promise((resolve, reject) => {
      db.query('SELECT id, name FROM users WHERE email = ?', [email], (err, results) => {
        if (err) reject(err);
        resolve(results);
      });
    });

    if (!user) {
      return res.status(404).json({ error: 'ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ñ Ñ‚Ð°ÐºÐ¸Ð¼ email Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½' });
    }

    // Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Ñ‚Ð¾ÐºÐµÐ½ Ð´Ð»Ñ ÑÐ±Ñ€Ð¾ÑÐ° Ð¿Ð°Ñ€Ð¾Ð»Ñ
    const resetToken = crypto.randomBytes(32).toString('hex');
    const tokenExpiry = new Date(Date.now() + 3600000); // Ð¢Ð¾ÐºÐµÐ½ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÐµÐ½ 1 Ñ‡Ð°Ñ

    // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ñ‚Ð¾ÐºÐµÐ½ Ð² Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…
    await new Promise((resolve, reject) => {
      db.query(
        'INSERT INTO email_verification_tokens (token, expires_at, user_id) VALUES (?, ?, ?)',
        [resetToken, tokenExpiry, user.id],
        (err) => {
          if (err) reject(err);
          resolve();
        }
      );
    });

    const resetLink = `http://localhost:8080/reset-password?token=${resetToken}`;

    if (email.endsWith("@gmail.com")) {
      const transporter = nodemailer.createTransport({
        service: 'gmail',
        auth: {
          user: process.env.GMAIL_USER,
          pass: process.env.GMAIL_PASS
        }
      });
  
      const mailOptions = {
        from: 'verifkon@gmail.com',
        to: email,
        subject: 'Ð¡Ð±Ñ€Ð¾Ñ Ð¿Ð°Ñ€Ð¾Ð»Ñ',
        html: generatePasswordResetEmail(user.name, resetLink)
      };
  
      await transporter.sendMail(mailOptions);

    } else if (email.endsWith("@mail.ru")) {
      const transporter = nodemailer.createTransport({
        host: 'smtp.mail.ru',
        port: 465,
        secure: true, // Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ SSL
        auth: {
          user: process.env.EMAIL_USER,
          pass: process.env.EMAIL_PASS
        }
      });

      transporter.verify((error, success) => {
        if (error) {
          console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ:', error);
        } else {
          console.log('Ð¡Ð¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾:', success);
        }
      });
  
      const mailOptions = {
        from: 'verification.email.verif@mail.ru',
        to: email,
        subject: 'Ð¡Ð±Ñ€Ð¾Ñ Ð¿Ð°Ñ€Ð¾Ð»Ñ',
        html: generatePasswordResetEmail(user.name, resetLink)
      };
  
      await transporter.sendMail(mailOptions);
    } else if (email.endsWith("@yandex.ru")) {

      const transporter = nodemailer.createTransport({
        host: 'smtp.yandex.ru',
        port: 465,
        secure: true, // Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ SSL
        auth: {
          user: process.env.YANDEX_EMAIL_USER,
          pass: process.env.YANDEX_EMAIL_PASS
        }
      });

      transporter.verify((error, success) => {
        if (error) {
          console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ:', error);
        } else {
          console.log('Ð¡Ð¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾:', success);
        }
      })
  
      const mailOptions = {
        from: 'vladyslav.necrasov@yandex.ru',
        to: email,
        subject: 'Ð¡Ð±Ñ€Ð¾Ñ Ð¿Ð°Ñ€Ð¾Ð»Ñ',
        html: generatePasswordResetEmail(user.name, resetLink)
      };
  
      await transporter.sendMail(mailOptions);
    }

    // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ email ÑÐ¾ ÑÑÑ‹Ð»ÐºÐ¾Ð¹ Ð´Ð»Ñ ÑÐ±Ñ€Ð¾ÑÐ° Ð¿Ð°Ñ€Ð¾Ð»Ñ
    
    res.json({ message: 'Ð˜Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸ Ð¿Ð¾ ÑÐ±Ñ€Ð¾ÑÑƒ Ð¿Ð°Ñ€Ð¾Ð»Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ñ‹ Ð½Ð° email' });

  } catch (error) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð¿Ñ€Ð¾ÑÐµ ÑÐ±Ñ€Ð¾ÑÐ° Ð¿Ð°Ñ€Ð¾Ð»Ñ:', error);
    res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°' });
  }
});

// Ð­Ð½Ð´Ð¿Ð¾Ð¸Ð½Ñ‚ Ð´Ð»Ñ ÑÐ±Ñ€Ð¾ÑÐ° Ð¿Ð°Ñ€Ð¾Ð»Ñ
router.post('/reset-password', async (req, res) => {
  const { token, newPassword } = req.body;

  try {
    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ‚Ð¾ÐºÐµÐ½Ð° Ð¸ ÐµÐ³Ð¾ ÑÑ€Ð¾Ðº Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ
    const query = 'SELECT user_id FROM email_verification_tokens WHERE token = ? AND expires_at > NOW()';
    db.query(query, [token], async (err, results) => {
      if (err) {
        console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐµ Ñ‚Ð¾ÐºÐµÐ½Ð°:', err);
        return res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°' });
      }

      if (results.length === 0) {
        return res.status(400).json({ error: 'Ð¢Ð¾ÐºÐµÐ½ Ð½ÐµÐ´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÐµÐ½ Ð¸Ð»Ð¸ Ð¸ÑÑ‚ÐµÐº' });
      }

      const userId = results[0].user_id;

      // Ð¥ÐµÑˆÐ¸Ñ€ÑƒÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ
      const hashedPassword = await bcrypt.hash(newPassword, 10);

      // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð² Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…
      db.query('UPDATE users SET password = ? WHERE id = ?', [hashedPassword, userId], (err) => {
        if (err) {
          console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¸ Ð¿Ð°Ñ€Ð¾Ð»Ñ:', err);
          return res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°' });
        }

        // Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ñ‚Ð¾ÐºÐµÐ½ Ð¿Ð¾ÑÐ»Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð³Ð¾ ÑÐ±Ñ€Ð¾ÑÐ° Ð¿Ð°Ñ€Ð¾Ð»Ñ
        db.query('DELETE FROM email_verification_tokens WHERE token = ?', [token], (err) => {
          if (err) {
            console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ð¸ Ñ‚Ð¾ÐºÐµÐ½Ð°:', err);
          }
        });

        res.status(200).json({ message: 'ÐŸÐ°Ñ€Ð¾Ð»ÑŒ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½' });
      });
    });
  } catch (error) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑÐ±Ñ€Ð¾ÑÐµ Ð¿Ð°Ñ€Ð¾Ð»Ñ:', error);
    res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°' });
  }
});


// âœ… **ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¾Ð¹ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸**
router.post('/update-user-info', (req, res) => {
  const { userId, phone, address } = req.body;

  db.query(
    'UPDATE users SET phone = ?, address = ? WHERE id = ?',
    [phone, address, userId],
    (err) => {
      if (err) {
        console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¸ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸:', err);
        return res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°' });
      }
      res.json({ message: 'Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð°' });
    }
  );
});

// âœ… **ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð¿ÐµÑÑŒÐ¼Ð° Ð²ÐµÑ€Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸ Ð½Ð° Gmail**
async function sendVerificationGmail(email, token, name) {
  const transporter = nodemailer.createTransport({
    service: 'gmail',
    auth: {
      user: process.env.GMAIL_USER,
      pass: process.env.GMAIL_PASS
    }
  });

  transporter.verify((error, success) => {
    if (error) {
      console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ:', error);
    } else {
      console.log('Ð¡Ð¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾:', success);
    }
  });

  const verificationLink = `http://localhost:8080/verify-account?token=${token}`;

  const mailOptions = {
    from: 'verifkon@gmail.com',
    to: email,
    subject: 'ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ Ð²Ð°ÑˆÐµÐ¹ Ð¿Ð¾Ñ‡Ñ‚Ñ‹',
    html: generateVerificationEmail(name, verificationLink),
  };

  await transporter.sendMail(mailOptions);
}

// âœ… **ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð¿ÐµÑÑŒÐ¼Ð° Ð²ÐµÑ€Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸ Ð½Ð° Email**
async function sendVerificationEmail(email, token, name) {
  const transporter = nodemailer.createTransport({
    host: 'smtp.mail.ru',
    port: 465,
    secure: true, // Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ SSL
    auth: {
      user: process.env.EMAIL_USER,
      pass: process.env.EMAIL_PASS
    }
  });

  transporter.verify((error, success) => {
    if (error) {
      console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ:', error);
    } else {
      console.log('Ð¡Ð¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾:', success);
    }
  });

  const verificationLink = `http://localhost:8080/verify-account?token=${token}`;

  const mailOptions = {
    from: 'verification.email.verif@mail.ru',
    to: email,
    subject: 'ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ Ð²Ð°ÑˆÐµÐ¹ Ð¿Ð¾Ñ‡Ñ‚Ñ‹',
    html: generateVerificationEmail(name, verificationLink),
  };

  await transporter.sendMail(mailOptions);
}

async function sendVerificationYandexEmail(email, token, name) {
  const transporter = nodemailer.createTransport({
    host: 'smtp.yandex.ru', // Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ð¹ Ñ…Ð¾ÑÑ‚
    port: 465,
    secure: true, // Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ SSL
    auth: {
      user: process.env.YANDEX_EMAIL_USER,
      pass: process.env.YANDEX_EMAIL_PASS
    }
  });

  console.log(process.env.YANDEX_EMAIL_USER)
  console.log(process.env.YANDEX_EMAIL_PASS)

  transporter.verify((error, success) => {
    if (error) {
      console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ:', error);
    } else {
      console.log('Ð¡Ð¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾:', success);
    }
  });

  const verificationLink = `http://localhost:8080/verify-account?token=${token}`;

  const mailOptions = {
    from: 'vladyslav.necrasov@yandex.ru',
    to: email,
    subject: 'ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ Ð²Ð°ÑˆÐµÐ¹ Ð¿Ð¾Ñ‡Ñ‚Ñ‹',
    html: generateVerificationEmail(name, verificationLink),
  };

  await transporter.sendMail(mailOptions);
}

// âœ… **Ð­Ð½Ð´Ð¿Ð¾Ð¸Ð½Ñ‚ Ð´Ð»Ñ Ð²ÐµÑ€Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ**
router.post('/verify-email', (req, res) => {
    const { token } = req.body;
    db.query(
        'SELECT * FROM email_verification_tokens WHERE token = ?',
        [token],
        (err, results) => {
            if (err) {
                return res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°.' });
            }

            if (results.length === 0) {
                return res.status(400).json({ error: 'ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð¸Ð»Ð¸ Ð¸ÑÑ‚ÐµÐºÑˆÐ¸Ð¹ Ñ‚Ð¾ÐºÐµÐ½.' });
            }

            const userId = results[0].user_id;

            db.query(
                'UPDATE users SET is_verified = 1 WHERE id = ?',
                [userId],
                (err) => {
                    if (err) {
                        return res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°.' });
                    }

                    db.query('DELETE FROM email_verification_tokens WHERE token = ?', [token]);

                    res.status(200).json({ message: 'Ð’Ð°ÑˆÐ° Ð¿Ð¾Ñ‡Ñ‚Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð°!' });
                }
            );
        }
    );
});

// âœ… **ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð½Ð°Ñ Ð²ÐµÑ€Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ñ*
router.post('/resend-verification', async (req, res) => {
  const { email } = req.body;

  try {
    const [user] = await new Promise((resolve, reject) => {
      db.query('SELECT * FROM users WHERE email = ?', [email], (err, results) => {
        if (err) reject(err);
        resolve(results);
      });
    });

    if (!user) {
      return res.status(404).json({ error: 'ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½' });
    }

    if (user.is_verified) {
      return res.status(400).json({ error: 'Email ÑƒÐ¶Ðµ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½' });
    }

    const token = crypto.randomBytes(32).toString('hex');
    
    await new Promise((resolve, reject) => {
      db.query(
        'INSERT INTO email_verification_tokens (user_id, token, expires_at) VALUES (?, ?, ?) ON DUPLICATE KEY UPDATE token = VALUES(token), expires_at = VALUES(expires_at)',
        [user.id, token, new Date(Date.now() + 3600000)],
        (err) => {
          if (err) reject(err);
          resolve();
        }
      );
    });

    if (email.endsWith("@gmail.com")) {
      console.log(`ðŸ“© ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ñ‡ÐµÑ€ÐµÐ· Gmail Ð½Ð° ${email}`);
      sendVerificationGmail(email, token, user.name);
    } else if (email.endsWith("@mail.ru")) {
      console.log(`ðŸ“© ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ñ‡ÐµÑ€ÐµÐ· Mail.ru Ð½Ð° ${email}`);
      sendVerificationEmail(email, token, user.name);
    } else if (email.endsWith("@yandex.ru")) {
      console.log(`ðŸ“© ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ñ‡ÐµÑ€ÐµÐ· Yandex.ru Ð½Ð° ${email}`);
      sendVerificationYandexEmail(email, token, user.name);
    }

    res.json({ message: 'ÐŸÐ¸ÑÑŒÐ¼Ð¾ Ñ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸ÐµÐ¼ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾' });
  } catch (error) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¾Ð¹ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐµ:', error);
    res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°' });
  }
});

// Ð­Ð½Ð´Ð¿Ð¾Ð¸Ð½Ñ‚ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ñ‚Ð¾ÐºÐµÐ½Ð°
router.post('/verify-token', async (req, res) => {
  const { token } = req.body;

  try {
    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ‚Ð¾ÐºÐµÐ½Ð° Ð² Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…
    const query = 'SELECT * FROM email_verification_tokens WHERE token = ? AND expires_at > NOW()';
    db.query(query, [token], (err, results) => {
      if (err) {
        console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐµ Ñ‚Ð¾ÐºÐµÐ½Ð°:', err);
        return res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°' });
      }

      if (results.length === 0) {
        return res.status(400).json({ error: 'Ð¢Ð¾ÐºÐµÐ½ Ð½ÐµÐ´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÐµÐ½ Ð¸Ð»Ð¸ Ð¸ÑÑ‚ÐµÐº' });
      }

      // Ð•ÑÐ»Ð¸ Ñ‚Ð¾ÐºÐµÐ½ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÐµÐ½
      res.status(200).json({ message: 'Ð¢Ð¾ÐºÐµÐ½ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÐµÐ½' });
    });
  } catch (error) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐµ Ñ‚Ð¾ÐºÐµÐ½Ð°:', error);
    res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°' });
  }
});

console.log('ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹ Ð² UserRoutes:');
router.stack.forEach(m => {
  if (m.route) {
    console.log(Object.keys(m.route.methods).join(', ').toUpperCase(), m.route.path);
  }
});

export default router;